<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin dashboard</title>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Color Palette & Design System */
            --color-primary: #00796b; /* Deeper Teal */
            --color-primary-hover: #00695c;
            --color-secondary: #ffab40; /* Amber accent */
            --color-background: #f4f6f8;
            --color-surface: #ffffff;
            --color-text: #263238;
            --color-text-secondary: #546e7a;
            --color-border: #eceff1;
            --color-success: #2e7d32;
            --color-warning: #f9a825;
            --color-error: #c62828;
            --color-info: #0277bd;
            --color-critical: #d32f2f; /* For manual emergencies */
            
            /* RGB versions for opacity */
            --color-primary-rgb: 0, 121, 107;

            /* Typography & Spacing */
            --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --radius-base: 8px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Base Styles */
        html { font-family: var(--font-family-base); background-color: var(--color-background); color: var(--color-text); }
        body { margin: 0; font-size: 14px; }
        .hidden { display: none !important; }

        /* Login Screen */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #26a69a 0%, #00796b 100%); padding: 20px; }
        .login-card { background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); padding: 40px; width: 100%; max-width: 420px; text-align: center; }
        .login-header h1 { color: var(--color-primary); margin-bottom: 8px; font-size: 24px; font-weight: 700; }
        
        /* Forms & Buttons */
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { font-weight: 500; font-size: 12px; margin-bottom: 8px; display: block; }
        .form-control { width: 100%; box-sizing: border-box; padding: 12px 16px; border-radius: var(--radius-base); border: 1px solid var(--color-border); transition: all var(--duration-normal) var(--ease-standard); }
        .form-control:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.2); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: var(--radius-base); font-weight: 600; cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); border: none; text-decoration: none; }
        .btn--primary { background-color: var(--color-primary); color: white; }
        .btn--primary:hover { background-color: var(--color-primary-hover); }
        .btn--error { background-color: var(--color-error); color: white; }
        .btn--error:hover { background-color: #b71c1c; }
        .btn--sm { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { background-color: #bdbdbd; cursor: not-allowed; }

        /* App Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--color-surface); border-right: 1px solid var(--color-border); display: flex; flex-direction: column; position: fixed; height: 100vh; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--color-border); }
        .nav-menu { flex: 1; list-style: none; padding: 16px 0; margin: 0; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: var(--color-text-secondary); text-decoration: none; margin: 4px 12px; border-radius: var(--radius-base); font-weight: 500; transition: all var(--duration-normal); }
        .nav-link.active { background-color: rgba(var(--color-primary-rgb), 0.1); color: var(--color-primary); font-weight: 600; }
        
        /* Main Content */
        .main-content { margin-left: 260px; flex: 1; background-color: var(--color-background); }
        .main-header { background-color: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-left h1 { font-size: 24px; margin: 0; }
        .header-actions .btn { margin-left: 16px; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .alert-indicator { position: relative; font-size: 20px; color: var(--color-text-secondary); cursor: pointer; }
        .alert-badge { position: absolute; top: -5px; right: -8px; background-color: var(--color-error); color: white; font-size: 10px; padding: 2px 5px; border-radius: 50%; font-weight: 700; border: 2px solid var(--color-surface); }
        
        .content-section { padding: 32px; display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Dashboard & Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .kpi-card { background-color: var(--color-surface); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 16px; border-left: 5px solid transparent; transition: all var(--duration-normal); cursor: pointer; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .kpi-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }
        .kpi-content h3 { font-size: 28px; font-weight: 700; margin: 0 0 4px; }
        .kpi-content p { margin: 0; color: var(--color-text-secondary); font-size: 12px; }
        
        /* Tables */
        .table-container { background-color: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--color-border); white-space: nowrap; }
        .data-table th { background-color: var(--color-background); font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .data-table .actions { display: flex; gap: 8px; }

        /* Map & Route Planning Styles */
        #map, #routeMap { height: 75vh; }
        .route-planning-layout { display: grid; grid-template-columns: 350px 1fr; gap: 24px; height: 75vh; }
        .route-controls-panel { background: var(--color-surface); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 16px; }
        #route-stops { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1;}
        #route-stops li { padding: 8px; border-radius: 4px; font-size: 12px; border-bottom: 1px solid var(--color-border); }
        #route-stops li.visited { text-decoration: line-through; color: var(--color-text-secondary); background-color: #fafafa; }
        .map-container { border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); }
        .map-controls { background-color: var(--color-surface); padding: 16px; border-radius: var(--radius-lg); margin-bottom: 24px; box-shadow: var(--shadow-sm); display: flex; gap: 20px; align-items: center; }

        /* Analytics & Predictions */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .prediction-card { background-color: var(--color-surface); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); }
        .prediction-list { list-style: none; padding: 0; margin: 0; }
        .prediction-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border); }
        .chart-card { background-color: var(--color-surface); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); }
        
        /* Modals & Toasts */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1002; }
        .toast { background-color: var(--color-surface); color: var(--color-text); padding: 16px; border-radius: var(--radius-base); box-shadow: var(--shadow-lg); margin-bottom: 10px; opacity: 0; transition: all 0.3s ease; transform: translateX(100%); border-left: 5px solid; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.toast--success { border-color: var(--color-success); }
        .toast.toast--error { border-color: var(--color-error); }
        .toast.toast--info { border-color: var(--color-info); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; opacity: 0; visibility: hidden; transition: all var(--duration-normal); }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--color-surface); border-radius: var(--radius-lg); padding: 32px; width: 90%; max-width: 500px; transform: scale(0.9); transition: all var(--duration-normal); }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-footer { margin-top: 24px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Responsive */
        @media (max-width: 1200px) { .analytics-grid, .route-planning-layout, .dashboard-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <div id="toastContainer"></div>

    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-recycle"></i> Safai Mitra</h1>
                <p>Admin Portal</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" value="admin@safaimitra.in" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" value="admin123" required>
                </div>
                <button type="submit" class="btn btn--primary" style="width: 100%;">Sign In</button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="app-container hidden">
        <nav class="sidebar">
             <div class="sidebar-header">
                <h2><i class="fas fa-recycle"></i> Safai Mitra</h2>
             </div>
            <ul class="nav-menu">
                <li><a href="#" data-section="dashboard" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                <li><a href="#" data-section="alerts" class="nav-link"><i class="fas fa-bell"></i> Alert Management</a></li>
                <li><a href="#" data-section="map" class="nav-link"><i class="fas fa-map-marked-alt"></i> Real-time Map</a></li>
                <li><a href="#" data-section="routes" class="nav-link"><i class="fas fa-route"></i> Route Planning</a></li>
                <li><a href="#" data-section="analytics" class="nav-link"><i class="fas fa-brain"></i> Analytics & Predictions</a></li>
                <li><a href="#" data-section="households" class="nav-link"><i class="fas fa-home"></i> Households</a></li>
                <li><a href="#" data-section="users" class="nav-link"><i class="fas fa-users-cog"></i> User Management</a></li>
                <li><a href="#" data-section="broadcast" class="nav-link"><i class="fas fa-bullhorn"></i> Broadcast Message</a></li>
            </ul>
             <div class="sidebar-footer" style="padding: 24px;"><button id="logoutBtn" class="btn btn--secondary" style="width: 100%;"><i class="fas fa-sign-out-alt"></i> Logout</button></div>
        </nav>

        <main class="main-content">
            <header class="main-header">
                <div class="header-left">
                    <h1 id="pageTitle">Dashboard</h1>
                    <div id="headerActions" class="header-actions"></div>
                </div>
                 <div class="header-right">
                    <div class="alert-indicator" id="alertIndicator"><i class="fas fa-bell"></i><span id="alertCount" class="alert-badge">0</span></div>
                </div>
            </header>
            
            <section id="dashboardSection" class="content-section active">
                <div class="kpi-grid">
                    <!-- KPIs will be rendered here by JS -->
                </div>
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <h4>Waste Distribution</h4>
                        <div style="height: 300px;"><canvas id="wasteDistributionChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Alerts by Type</h4>
                        <div style="height: 300px;"><canvas id="alertsByTypeChart"></canvas></div>
                    </div>
                </div>
            </section>
            
            <section id="alertsSection" class="content-section">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Household</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="mapSection" class="content-section">
                <div class="map-controls">
                    <div>
                        <label for="areaFilter" class="form-label">Filter by Area:</label>
                        <select id="areaFilter" class="form-control" style="display: inline-block; width: auto;"></select>
                    </div>
                     <div>
                        <label for="statusFilter" class="form-label">Filter by Status:</label>
                        <select id="statusFilter" class="form-control" style="display: inline-block; width: auto;">
                            <option value="all">All Statuses</option>
                            <option value="online">Online</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                </div>
                <div id="map" class="map-container"></div>
            </section>
            
            <section id="routesSection" class="content-section">
                 <div class="route-planning-layout">
                    <div class="route-controls-panel">
                        <h3>Route Controls</h3>
                        <button class="btn btn--primary" onclick="app.findUrgentCollections()"><i class="fas fa-search-location"></i> Find Urgent Collections</button>
                        <button class="btn btn--secondary" onclick="app.optimizeRoute()" id="optimizeBtn" disabled><i class="fas fa-magic"></i> Optimize Route</button>
                        <div id="route-info" class="hidden">
                            <p><strong>Route Ready:</strong> <span id="route-stops-count">0</span> stops, <span id="route-distance">0</span> km</p>
                            <button class="btn btn--primary" onclick="app.startRouteTracking()" id="startTrackingBtn"><i class="fas fa-play"></i> Start Live Tracking</button>
                            <button class="btn btn--secondary hidden" onclick="app.pauseRouteTracking()" id="pauseTrackingBtn"><i class="fas fa-pause"></i> Pause</button>
                            <button class="btn btn--error hidden" onclick="app.stopRouteTracking()" id="stopTrackingBtn"><i class="fas fa-stop"></i> Stop</button>
                        </div>
                        <h4>Stops:</h4>
                        <ul id="route-stops"></ul>
                    </div>
                    <div id="routeMap" class="map-container"></div>
                </div>
            </section>
            
            <section id="analyticsSection" class="content-section">
                <h3>Analytics & Predictions</h3>
                <div class="analytics-grid">
                    <div class="prediction-card">
                        <h4><i class="fas fa-lightbulb"></i> AI-Powered Overflow Prediction (Next 24h)</h4>
                        <p>Households likely to require collection soon based on fill rate history.</p>
                        <ul id="prediction-list" class="prediction-list"></ul>
                    </div>
                     <div class="chart-card">
                        <h4>Historical Waste Volume</h4>
                        <div style="height: 300px;"><canvas id="historicalWasteChart"></canvas></div>
                    </div>
                </div>
            </section>
            
            <section id="householdsSection" class="content-section">
                 <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>Address</th><th>Area</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="householdsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="usersSection" class="content-section">
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="broadcastSection" class="content-section">
                <h3>Broadcast Notification</h3>
                <p>Send a message to all connected user dashboards.</p>
                <div class="form-group">
                    <label class="form-label">Message Title</label>
                    <input type="text" id="broadcastTitle" class="form-control" placeholder="e.g., Special Collection Notice">
                </div>
                <div class="form-group">
                    <label class="form-label">Message Body</label>
                    <textarea id="broadcastMessage" class="form-control" rows="4" placeholder="Enter your message here..."></textarea>
                </div>
                <button class="btn btn--primary" onclick="app.sendBroadcast()"><i class="fas fa-paper-plane"></i> Send Broadcast</button>
            </section>

        </main>
    </div>
    
    <!-- Universal Modal -->
    <div id="universalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="modal-close" onclick="app.closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        class SafaiMitraAdminApp {
            constructor() {
                this.currentUser = null;
                this.map = null;
                this.routeMap = null;
                this.charts = {};
                this.markers = { main: [], route: [] };
                this.data = {};
                this.realTimeInterval = null;
                this.routeState = { polyline: null, vehicleMarker: null, waypoints: [], animationFrameId: null, isPaused: false, isRunning: false };
            }

            init() {
                this.setupEventListeners();
                this.loadData();
                this.checkSession();
            }
            
            loadData() {
                const savedData = localStorage.getItem('safaiMitraData');
                if (savedData) {
                    this.data = JSON.parse(savedData);
                } else {
                    this.data = this.generateDurgapurData();
                    this.saveData();
                }
            }
            
            saveData() {
                localStorage.setItem('safaiMitraData', JSON.stringify(this.data));
            }

            generateAlerts(households) {
                const alerts = households.filter(h => h.organic > 90 || h.recyclable > 95 || h.hazardous > 80)
                    .map((h, index) => ({
                        id: `ALERT${h.id.slice(-4)}`,
                        householdId: h.id,
                        area: h.area,
                        type: h.organic > 90 ? 'Organic Full' : (h.recyclable > 95 ? 'Recyclable Full' : 'Hazardous Detected'),
                        priority: 'high',
                        status: 'pending',
                        timestamp: new Date(Date.now() - index * 1000 * 60 * 15).toISOString()
                }));
                for(let i = 0; i < alerts.length; i+=3) {
                    if(alerts[i]) alerts[i].status = 'acknowledged';
                }
                return { alerts };
            }

            generateDurgapurData() {
                const areas = [{ name: "City Centre", center: [23.538, 87.31] }, { name: "Benachity", center: [23.53, 87.33] }, { name: "Steel Township", center: [23.55, 87.30] }, { name: "Bidhannagar", center: [23.51, 87.35] }, { name: "A-Zone", center: [23.56, 87.29] }];
                const households = Array.from({ length: 150 }, (_, i) => {
                    const area = areas[i % areas.length];
                    return {
                        id: `DGPHH${String(i + 1).padStart(4, '0')}`,
                        address: `House #${Math.floor(Math.random() * 100) + 1}, Sector ${i % 5 + 1}`,
                        area: area.name,
                        lat: area.center[0] + (Math.random() - 0.5) * 0.02,
                        lng: area.center[1] + (Math.random() - 0.5) * 0.02,
                        status: Math.random() > 0.1 ? 'online' : 'offline',
                        organic: Math.floor(Math.random() * 101),
                        recyclable: Math.floor(Math.random() * 101),
                        hazardous: Math.floor(Math.random() * 41),
                    };
                });
                const users = [ { id: 'USER1', name: 'S. Banerjee', email: 's.banerjee@dmc.gov.in', role: 'Admin', status: 'Active' }, { id: 'USER2', name: 'P. Roy', email: 'p.roy@dmc.gov.in', role: 'Staff', status: 'Active' } ];
                const { alerts } = this.generateAlerts(households);
                return { households, alerts, users, areas };
            }

            setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
                document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showSection(e.currentTarget.dataset.section);
                    });
                });
                document.getElementById('alertIndicator').addEventListener('click', () => this.showSection('alerts'));
                document.getElementById('areaFilter').addEventListener('change', () => this.renderMapMarkers());
                document.getElementById('statusFilter').addEventListener('change', () => this.renderMapMarkers());
            }
            
            checkSession() {
                const user = localStorage.getItem('safaiMitraUser');
                if (user) {
                    this.currentUser = JSON.parse(user);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    this.showSection('dashboard');
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('hidden');
                }
            }

            handleLogin() {
                 const email = document.getElementById('loginEmail').value;
                 const password = document.getElementById('loginPassword').value;
                 if (email === 'admin@safaimitra.in' && password === 'admin123') {
                     this.currentUser = { name: 'Admin', email };
                     localStorage.setItem('safaiMitraUser', JSON.stringify(this.currentUser));
                     this.checkSession();
                 } else { this.showToast('Invalid credentials', 'error'); }
            }

            handleLogout() {
                this.currentUser = null;
                localStorage.removeItem('safaiMitraUser');
                this.checkSession();
            }

            showSection(sectionName) {
                const headerActions = document.getElementById('headerActions');
                headerActions.innerHTML = '';
                if (sectionName === 'users') {
                    headerActions.innerHTML = `<button class="btn btn--primary" onclick="app.openUserModal()"><i class="fas fa-plus"></i> Add User</button>`;
                } else if (sectionName === 'households') {
                    headerActions.innerHTML = `<button class="btn btn--primary" onclick="app.openHouseholdModal()"><i class="fas fa-plus"></i> Add Household</button>`;
                }

                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(`${sectionName}Section`).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-section="${sectionName}"]`).classList.add('active');
                document.getElementById('pageTitle').textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1).replace('-', ' ');
                
                requestAnimationFrame(() => {
                    switch (sectionName) {
                        case 'dashboard': this.renderDashboard(); break;
                        case 'alerts': this.renderAlerts(); break;
                        case 'map': this.initializeMap('map'); break;
                        case 'routes': this.initializeMap('routeMap'); break;
                        case 'analytics': this.renderAnalytics(); break;
                        case 'households': this.renderHouseholds(); break;
                        case 'users': this.renderUsers(); break;
                    }
                });
            }

            renderDashboard() {
                const pendingAlerts = this.data.alerts.filter(a => a.status === 'pending').length;
                const onlineDevices = this.data.households.filter(h => h.status === 'online').length;
                const kpiGrid = document.querySelector('#dashboardSection .kpi-grid');
                kpiGrid.innerHTML = `
                    <div class="kpi-card" style="border-color: var(--color-info);" onclick="app.showSection('households')">
                        <div class="kpi-icon" style="background-color: var(--color-info);"><i class="fas fa-home"></i></div>
                        <div class="kpi-content"><h3>${this.data.households.length}</h3><p>Total Households</p></div>
                    </div>
                    <div class="kpi-card" style="border-color: var(--color-success);">
                        <div class="kpi-icon" style="background-color: var(--color-success);"><i class="fas fa-wifi"></i></div>
                        <div class="kpi-content"><h3>${onlineDevices}</h3><p>Online Devices</p></div>
                    </div>
                     <div class="kpi-card" style="border-color: var(--color-error);" onclick="app.showSection('alerts')">
                        <div class="kpi-icon" style="background-color: var(--color-error);"><i class="fas fa-bell"></i></div>
                        <div class="kpi-content"><h3>${pendingAlerts}</h3><p>Pending Alerts</p></div>
                    </div>`;
                document.getElementById('alertCount').textContent = pendingAlerts;
                this.renderDashboardCharts();
            }

            renderDashboardCharts() {
                const distCanvas = document.getElementById('wasteDistributionChart');
                if (distCanvas) {
                    if (this.charts.distribution) this.charts.distribution.destroy();
                    this.charts.distribution = new Chart(distCanvas.getContext('2d'), { type: 'doughnut', data: { labels: ['Organic', 'Recyclable', 'Hazardous'], datasets: [{ data: [this.data.households.reduce((s, h) => s + h.organic, 0), this.data.households.reduce((s, h) => s + h.recyclable, 0), this.data.households.reduce((s, h) => s + h.hazardous, 0)], backgroundColor: ['var(--color-success)', 'var(--color-info)', 'var(--color-error)'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}} });
                }
                const alertsCanvas = document.getElementById('alertsByTypeChart');
                if(alertsCanvas) {
                    if(this.charts.alertsByType) this.charts.alertsByType.destroy();
                    const alertTypes = this.data.alerts.reduce((acc, alert) => { acc[alert.type] = (acc[alert.type] || 0) + 1; return acc; }, {});
                    this.charts.alertsByType = new Chart(alertsCanvas.getContext('2d'), { type: 'bar', data: { labels: Object.keys(alertTypes), datasets: [{ label: 'Number of Alerts', data: Object.values(alertTypes), backgroundColor: 'rgba(var(--color-primary-rgb), 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                }
            }
            
            renderAlerts() {
                const tbody = document.getElementById('alertsTableBody');
                if (!tbody) return;
                tbody.innerHTML = this.data.alerts.map(alert => `
                    <tr>
                        <td>${alert.id}</td><td>${alert.householdId}</td><td>${alert.type}</td>
                        <td><span style="color:${alert.priority === 'high' || alert.priority === 'critical' ? 'var(--color-error)' : 'var(--color-warning)'}">${alert.priority}</span></td>
                        <td>${alert.status}</td><td>${new Date(alert.timestamp).toLocaleString()}</td>
                        <td class="actions"><button class="btn btn--sm" onclick="app.acknowledgeAlert('${alert.id}')" ${alert.status === 'acknowledged' ? 'disabled' : ''}><i class="fas fa-check"></i> Acknowledge</button></td>
                    </tr>`).join('');
            }
            
            acknowledgeAlert(alertId) {
                const alert = this.data.alerts.find(a => a.id === alertId);
                if (alert && alert.status === 'pending') {
                    alert.status = 'acknowledged';
                    this.saveData(); this.renderAlerts(); this.renderDashboard();
                    this.showToast(`Alert ${alertId} has been acknowledged.`, 'success');
                }
            }

            initializeMap(mapId) {
                const mapContainer = document.getElementById(mapId); if (!mapContainer) return;
                const mapInstanceName = mapId === 'map' ? 'map' : 'routeMap';
                if (this[mapInstanceName]) { this[mapInstanceName].invalidateSize(); } 
                else {
                    this[mapInstanceName] = L.map(mapId).setView([23.54, 87.31], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this[mapInstanceName]);
                }
                if (mapId === 'map') {
                    const areaFilter = document.getElementById('areaFilter');
                    areaFilter.innerHTML = '<option value="all">All Areas</option>' + this.data.areas.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
                    this.renderMapMarkers();
                }
                if (mapId === 'routeMap') this.stopRouteTracking();
            }
            
            renderMapMarkers() {
                if(!this.map) return;
                const areaFilter = document.getElementById('areaFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const filteredHouseholds = this.data.households.filter(h => 
                    (areaFilter === 'all' || h.area === areaFilter) && 
                    (statusFilter === 'all' || h.status === statusFilter)
                );
                
                this.markers.main.forEach(m => m.remove());
                this.markers.main = [];
                filteredHouseholds.forEach(h => {
                    const marker = L.circleMarker([h.lat, h.lng], { radius: 8, fillColor: h.status === 'online' ? 'var(--color-success)' : 'var(--color-error)', color: 'white', weight: 2, fillOpacity: 0.8 }).addTo(this.map);
                    marker.bindPopup(`<b>${h.id}</b><br>${h.address}`);
                    this.markers.main.push(marker);
                });
            }

            // --- ALL CRUD OPERATIONS ---
            openUserModal(userId = null) {
                const user = userId ? this.data.users.find(u => u.id === userId) : null;
                this.showModal({ title: user ? 'Edit User' : 'Add New User', body: `<div class="form-group"><label class="form-label">Full Name</label><input type="text" id="userName" class="form-control" value="${user ? user.name : ''}" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" id="userEmail" class="form-control" value="${user ? user.email : ''}" required></div><div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-control"><option value="Admin" ${user && user.role === 'Admin' ? 'selected' : ''}>Admin</option><option value="Staff" ${user && user.role === 'Staff' ? 'selected' : ''}>Staff</option></select></div>`, footer: `<button class="btn btn--secondary" onclick="app.closeModal()">Cancel</button><button class="btn btn--primary" onclick="app.saveUser('${userId || ''}')">Save</button>` });
            }

            saveUser(userId) {
                const name = document.getElementById('userName').value.trim(); const email = document.getElementById('userEmail').value.trim(); const role = document.getElementById('userRole').value;
                if (!name || !email) { this.showToast("Name and email are required.", "error"); return; }
                if (userId) { const user = this.data.users.find(u => u.id === userId); user.name = name; user.email = email; user.role = role; } 
                else { this.data.users.push({ id: `USER${Date.now()}`, name, email, role, status: 'Active' }); }
                this.saveData(); this.renderUsers(); this.closeModal(); this.showToast(`User ${userId ? 'updated' : 'added'} successfully.`, "success");
            }

            deleteUser(userId) {
                if (confirm('Are you sure you want to delete this user?')) { this.data.users = this.data.users.filter(u => u.id !== userId); this.saveData(); this.renderUsers(); this.showToast("User deleted.", "success"); }
            }
            
            openHouseholdModal(householdId = null) {
                const household = householdId ? this.data.households.find(h => h.id === householdId) : null;
                const areasOptions = this.data.areas.map(area => `<option value="${area.name}" ${household && household.area === area.name ? 'selected' : ''}>${area.name}</option>`).join('');
                this.showModal({ title: household ? 'Edit Household' : 'Add New Household', body: `<div class="form-group"><label class="form-label">Address</label><input type="text" id="householdAddress" class="form-control" value="${household ? household.address : ''}" required></div><div class="form-group"><label class="form-label">Area</label><select id="householdArea" class="form-control">${areasOptions}</select></div>`, footer: `<button class="btn btn--secondary" onclick="app.closeModal()">Cancel</button><button class="btn btn--primary" onclick="app.saveHousehold('${householdId || ''}')">Save</button>` });
            }

            saveHousehold(householdId) {
                const address = document.getElementById('householdAddress').value.trim(); const areaName = document.getElementById('householdArea').value;
                if (!address || !areaName) { this.showToast("Address and area are required.", "error"); return; }
                const area = this.data.areas.find(a => a.name === areaName);
                if (householdId) { const household = this.data.households.find(h => h.id === householdId); household.address = address; household.area = areaName; } 
                else { this.data.households.push({ id: `DGPHH${Date.now().toString().slice(-4)}`, address, area: areaName, lat: area.center[0] + (Math.random() - 0.5) * 0.02, lng: area.center[1] + (Math.random() - 0.5) * 0.02, status: 'online', organic: 0, recyclable: 0, hazardous: 0 }); }
                this.saveData(); this.renderHouseholds(); this.closeModal(); this.showToast(`Household ${householdId ? 'updated' : 'added'} successfully.`, "success");
            }
            
            deleteHousehold(householdId) {
                if (confirm('Are you sure you want to delete this household?')) { this.data.households = this.data.households.filter(h => h.id !== householdId); this.data.alerts = this.data.alerts.filter(a => a.householdId !== householdId); this.saveData(); this.renderHouseholds(); this.showToast("Household deleted.", "success"); }
            }

            renderUsers() {
                const tbody = document.getElementById('usersTableBody'); if(!tbody) return;
                tbody.innerHTML = this.data.users.map(user => `<tr><td>${user.name}</td><td>${user.email}</td><td>${user.role}</td><td>${user.status}</td><td class="actions"><button class="btn btn--sm" onclick="app.openUserModal('${user.id}')"><i class="fas fa-edit"></i> Edit</button><button class="btn btn--sm btn--error" onclick="app.deleteUser('${user.id}')"><i class="fas fa-trash"></i> Delete</button></td></tr>`).join('');
            }
            
            renderHouseholds() {
                const tbody = document.getElementById('householdsTableBody'); if(!tbody) return;
                tbody.innerHTML = this.data.households.map(h => `<tr><td>${h.id}</td><td>${h.address}</td><td>${h.area}</td><td><span style="color:${h.status === 'online' ? 'var(--color-success)' : 'var(--color-error)'}">${h.status}</span></td><td class="actions"><button class="btn btn--sm" onclick="app.openHouseholdModal('${h.id}')"><i class="fas fa-edit"></i> Edit</button><button class="btn btn--sm btn--error" onclick="app.deleteHousehold('${h.id}')"><i class="fas fa-trash"></i> Delete</button><button class="btn btn--sm" style="background-color: var(--color-warning);" onclick="app.triggerManualAlert('${h.id}')"><i class="fas fa-bell"></i> Alert</button></td></tr>`).join('');
            }
            
            // --- ROUTE PLANNING ---
            findUrgentCollections() {
                const urgentHouseholds = this.data.households.filter(h => h.organic > 90 || h.recyclable > 90 || h.hazardous > 50);
                if (urgentHouseholds.length === 0) { this.showToast("No urgent collections found.", "info"); return; }
                this.routeState.waypoints = urgentHouseholds;
                document.getElementById('route-stops').innerHTML = urgentHouseholds.map(h => `<li>${h.id} - ${h.address}</li>`).join('');
                document.getElementById('optimizeBtn').disabled = false;
                document.getElementById('route-info').classList.add('hidden');
                this.showToast(`${urgentHouseholds.length} urgent collections found. Ready to optimize.`, "success");
            }

            haversineDistance(c1, c2) { const R=6371,dLat= (c2.lat-c1.lat)*Math.PI/180,dLon=(c2.lng-c1.lng)*Math.PI/180; return R * 2 * Math.atan2(Math.sqrt(Math.sin(dLat/2)**2 + Math.cos(c1.lat*Math.PI/180)*Math.cos(c2.lat*Math.PI/180)*Math.sin(dLon/2)**2), Math.sqrt(1-(Math.sin(dLat/2)**2 + Math.cos(c1.lat*Math.PI/180)*Math.cos(c2.lat*Math.PI/180)*Math.sin(dLon/2)**2))); }

            optimizeRoute() {
                let unvisited = [...this.routeState.waypoints];
                if (unvisited.length < 2) { this.showToast("Not enough stops.", "info"); return; }
                let route = [unvisited.shift()];
                while(unvisited.length > 0) { let nearest = unvisited.reduce((prev, curr, i) => { const dist = this.haversineDistance(route[route.length-1], curr); return dist < prev.dist ? {dist, i} : prev; }, {dist:Infinity, i:-1}); route.push(unvisited.splice(nearest.i, 1)[0]); }
                this.routeState.waypoints = route;
                document.getElementById('route-stops').innerHTML = route.map(h => `<li>${h.id} - ${h.address}</li>`).join('');
                let totalDistance = route.slice(1).reduce((sum, stop, i) => sum + this.haversineDistance(route[i], stop), 0);
                document.getElementById('route-stops-count').textContent = route.length;
                document.getElementById('route-distance').textContent = totalDistance.toFixed(2);
                document.getElementById('route-info').classList.remove('hidden');
                this.drawRouteOnMap(route);
                this.showToast("Route optimized!", "success");
            }

            drawRouteOnMap(waypoints) {
                if (!this.routeMap) return;
                if (this.routeState.polyline) this.routeState.polyline.remove();
                this.markers.route.forEach(m => m.remove()); this.markers.route = [];
                const latLngs = waypoints.map(h => [h.lat, h.lng]);
                this.routeState.polyline = L.polyline(latLngs, {color: 'var(--color-primary)'}).addTo(this.routeMap);
                this.routeMap.fitBounds(this.routeState.polyline.getBounds().pad(0.1));
                waypoints.forEach((h, i) => { this.markers.route.push(L.marker([h.lat, h.lng], { icon: L.divIcon({ className: 'route-marker', html: `<span style="background:var(--color-primary); color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; border:2px solid white; box-shadow:var(--shadow-sm);">${i + 1}</span>`, iconSize: [24, 24] }) }).addTo(this.routeMap).bindPopup(`Stop ${i+1}: ${h.id}`)); });
            }

            startRouteTracking() {
                if (this.routeState.waypoints.length === 0) { this.showToast("No route.", "error"); return; }
                if (this.routeState.vehicleMarker) this.routeState.vehicleMarker.remove();
                this.routeState.vehicleMarker = L.marker(this.routeState.waypoints[0], {icon: L.divIcon({ html: `<i class="fas fa-truck" style="font-size: 24px; color: var(--color-success);"></i>`, className: 'vehicle-icon', iconSize: [24,24]})}).addTo(this.routeMap);
                Object.assign(this.routeState, {isRunning:true, isPaused:false, currentIndex:0, step:0});
                document.getElementById('startTrackingBtn').classList.add('hidden');
                document.getElementById('pauseTrackingBtn').classList.remove('hidden');
                document.getElementById('stopTrackingBtn').classList.remove('hidden');
                this.animateVehicle();
                this.showToast("Tracking started.", "info");
            }

            animateVehicle() {
                if (!this.routeState.isRunning || this.routeState.isPaused) return;
                const { waypoints, currentIndex } = this.routeState;
                if (!waypoints[currentIndex + 1]) { this.stopRouteTracking(); this.showToast("Route completed!", "success"); return; }
                this.routeState.step++;
                const [curr, next] = [waypoints[currentIndex], waypoints[currentIndex+1]];
                this.routeState.vehicleMarker.setLatLng([curr.lat + (next.lat - curr.lat) * (this.routeState.step / 100), curr.lng + (next.lng - curr.lng) * (this.routeState.step / 100)]);
                if (this.routeState.step >= 100) { this.routeState.currentIndex++; this.routeState.step = 0; document.querySelector(`#route-stops li:nth-child(${this.routeState.currentIndex})`).classList.add('visited'); }
                this.routeState.animationFrameId = requestAnimationFrame(() => this.animateVehicle());
            }

            pauseRouteTracking() {
                this.routeState.isPaused = !this.routeState.isPaused;
                const btn = document.getElementById('pauseTrackingBtn');
                if (this.routeState.isPaused) { cancelAnimationFrame(this.routeState.animationFrameId); btn.innerHTML = `<i class="fas fa-play"></i> Resume`; this.showToast("Paused.", "info"); } 
                else { this.animateVehicle(); btn.innerHTML = `<i class="fas fa-pause"></i> Pause`; this.showToast("Resumed.", "info"); }
            }

            stopRouteTracking() {
                 cancelAnimationFrame(this.routeState.animationFrameId);
                 Object.assign(this.routeState, {isRunning: false, isPaused: false});
                 if (this.routeState.vehicleMarker) {this.routeState.vehicleMarker.remove(); this.routeState.vehicleMarker=null;}
                 document.getElementById('startTrackingBtn').classList.remove('hidden');
                 document.getElementById('pauseTrackingBtn').classList.add('hidden');
                 document.getElementById('stopTrackingBtn').classList.add('hidden');
                 document.querySelectorAll('#route-stops li').forEach(li => li.classList.remove('visited'));
                 this.showToast("Tracking stopped.", "info");
            }

            // --- ADVANCED FEATURES ---
            triggerManualAlert(householdId) {
                if(confirm(`Trigger a manual high-priority alert for ${householdId}?`)) {
                    const household = this.data.households.find(h => h.id === householdId);
                    this.data.alerts.unshift({ id: `MANUAL${Date.now()}`, householdId, area: household.area, type: 'Manual Alert', priority: 'critical', status: 'pending', timestamp: new Date().toISOString() });
                    this.saveData(); this.showToast(`Critical alert triggered for ${householdId}.`, 'error'); this.renderDashboard();
                }
            }

            renderAnalytics() {
                this.renderHistoricalWasteChart(); this.renderPredictions();
            }

            renderHistoricalWasteChart() {
                const canvas = document.getElementById('historicalWasteChart'); if(!canvas) return;
                if (this.charts.historical) this.charts.historical.destroy();
                this.charts.historical = new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Total Waste (Tons)', data: [120, 150, 130, 180, 210, 200], borderColor: 'var(--color-primary)', tension: 0.4, fill: true, backgroundColor: 'rgba(var(--color-primary-rgb), 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false } });
            }

            renderPredictions() {
                const predictions = this.data.households.filter(h => h.status === 'online' && (h.organic > 75 || h.recyclable > 75)).sort((a,b) => (b.organic+b.recyclable)-(a.organic+a.recyclable)).slice(0, 5);
                const list = document.getElementById('prediction-list'); if(!list) return;
                list.innerHTML = predictions.length === 0 ? '<li>No households are at high risk.</li>' : predictions.map(p => `<li><span>${p.id} (${p.area})</span> <strong>${Math.max(p.organic, p.recyclable)}% Full</strong></li>`).join('');
            }
            
            sendBroadcast() {
                const title = document.getElementById('broadcastTitle').value; const message = document.getElementById('broadcastMessage').value;
                if (!title || !message) { this.showToast("Title and message required.", "error"); return; }
                this.showToast(`Broadcast Sent: "${title}"`, "success");
                document.getElementById('broadcastTitle').value = ''; document.getElementById('broadcastMessage').value = '';
                this.showSection('dashboard');
            }

            // --- UNIVERSAL MODAL & TOAST ---
            showModal({ title, body, footer }) {
                document.getElementById('modalTitle').innerHTML = title; document.getElementById('modalBody').innerHTML = body; document.getElementById('modalFooter').innerHTML = footer; document.getElementById('universalModal').classList.add('show');
            }
            closeModal() { document.getElementById('universalModal').classList.remove('show'); }
            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast toast--${type}`; toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => { toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000); }, 10);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { window.app = new SafaiMitraAdminApp(); window.app.init(); });
    </script>
</body>
</html>

